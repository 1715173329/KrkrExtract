<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>KrkrExtract Ver3.0.0.0 发布！提供更方便的汉化方式</title>
<link href="http://img.t.sinajs.cn/t6/style/css/module/base/frame.css?_v=81fb3096e0cb50b48519c92b680b9f0d" type="text/css" rel="stylesheet" />
<link href="http://img.t.sinajs.cn/t6/style/css/module/combination/comb_artical.css?_v=81fb3096e0cb50b48519c92b680b9f0d" type="text/css" rel="stylesheet" />
<link id="uuskin_host" href="http://img.t.sinajs.cn/t6/skin/default/skin.css?_v=81fb3096e0cb50b48519c92b680b9f0d" type="text/css" rel="stylesheet" />
<script type="text/javascript">
var $CONFIG = {};
$CONFIG['uid'] = '0';
$CONFIG['nick'] = '';
$CONFIG['onick'] = 'CrySirror';
$CONFIG['oid'] = '2670133861';
$CONFIG['isPay'] = '0';
$CONFIG['isMask'] = '0';
$CONFIG['article_list_url'] = '/2670133861/wenzhang';
$CONFIG['isImport'] = '0';
$CONFIG['cssPath'] = 'http://img.t.sinajs.cn';
$CONFIG['jsPath'] = 'http://js.t.sinajs.cn';
$CONFIG['tt_version'] = '81fb3096e0cb50b48519c92b680b9f0d';
</script>
</head>
<body class="B_artical ">
  <div class="WB_miniblog" id="articleRoot">
    <div class="WB_main clearfix" id="plc_frame">
      <div class="WB_frame">
        <div id="plc_main">
          <div class="WB_frame_a">
            <div class="WB_cardwrap S_bg2">
              <div class="WB_artical">
                <div class="main_editor " node-type="articleContent">
                  <div class="title" node-type="articleTitle">KrkrExtract Ver3.0.0.0 发布！提供更方便的汉化方式</div>
                    <div class="authorinfo clearfix S_txt2">
                      <div class="W_fl">
                        <span class="author1 W_autocut">
                          <img title="" alt="" src="http://tvax1.sinaimg.cn/crop.31.53.182.182.50/9f270265ly8ffmd11czryj206h06k75w.jpg" class="W_face_radius"/>
                          <a href="/u/2670133861" class="S_txt1" target="_blank">CrySirror<i title="微博个人认证 " class="W_icon icon_approve"></i></a>
                        </span>
                      <em class="W_vline S_line1"></em>
                      <span class="time">2017-04-12 20:25:55</span>
                      <em class="W_vline S_line1"></em>
                      <span class="del">
                        <a href="javascript:void(0);"
                         onclick="javascript:window.open('http://service.account.weibo.com/reportspam?rid=4095807034562268&type=32&from=11101',
                         'newwindow', 'height=700, width=550, toolbar =yes, menubar=no, scrollbars=yes, resizable=yes, location=no, status=no');
                         "suda-uatrack="key=tblog_headline_article&value=headline_pc_trend_report_click">举报</a>
                      </span>
                      </div>
                      <div class="W_fr">
                        <span class="num">阅读数：11408</span>
                      </div>
                    </div>
                  <div class="preface">提供通用汉化方式</div>
                  <div class="WB_editor_iframe" node-type="contentBody" style="visibility: hidden">
                      <p>​​别的废话我就懒得说了。</p>
                      <p>1.修复了2.0.x版本由于版本时带来的稳定性问题</p>
                      <p>2.通用Krkr补丁技术（我很懒，说是通用，但现在实际上只支持Krkrz引擎</p>
                      <p>3.移除了对Windows XP的支持（都7102年了，还XP？？）</p>
                      <p>为啥不支持Krkr2呢，并不是引擎上有改版问题，要怪就怪傻逼的bcb编译器吧，把代码编译成了一拖shit。以后看心情再说添加支持的问题吧。</p>
                      <p>本次的重点在第二条，于是我就随手找个游戏来做说明吧。</p>
                      <p>
                        <p img-box="img-box" class="picbox">
                          <img src="http://wx4.sinaimg.cn/large/9f270265gy1fek5c3d85tj20le07kjs8.jpg" alt=""/>
                        <span class="picinfo" style="display:none;"></span>
                        </p>
                      </p>
                      <p>​</p>
                      <p>（求别吐槽乱码）</p>
                      <p>使用KrkrExtract打开游戏后，我们可以看到：</p>
                      <p>
                        <p img-box="img-box" class="picbox">
                          <img src="http://wx3.sinaimg.cn/large/9f270265gy1fek5edvt6nj20j10art97.jpg" alt=""/>
                          <span class="picinfo" style="display:none;"> </span>
                        </p>
                      </p>
                      <p>​</p>
                      <p>在封包设定下面有一个Make Universal Patch的按键。没错，如果你当前启动的游戏是基于Krkrz，你只需要轻轻一点，就会出现一个补丁成功的提示窗口：</p>
                      <p>
                        <p img-box="img-box" class="picbox"><img src="http://wx1.sinaimg.cn/large/9f270265gy1fek5i7m37tj206m058dfo.jpg" alt=""/>
                        <span class="picinfo" style="display:none;"></span>
                        </p>
                      </p>
                      <p>​</p>
                      <p>现在，我们游戏目录下出现了两个新文件：</p>
                      <p>
                        <p img-box="img-box" class="picbox"><img src="http://wx1.sinaimg.cn/large/9f270265gy1fek5iq2rdij20d704x3ys.jpg" alt=""/>
                        <span class="picinfo" style="display:none;"></span>
                        </p>
                      </p>
                      <p>​</p>
                      <p>我说明一下，xxx_Patch.exe就是补丁启动文件，而KrkrUniversalPatch.dll就是补丁文件。因为当前还是没封包的状态（等下我解释如何制作自定义封包），补丁默认读取当前目录的ProjectDir文件夹。</p>
                      <p>那行吧，我把AppConfig.tjs的中的标题名改一改：</p>
                      <p>
                        <p img-box="img-box" class="picbox"><img src="http://wx2.sinaimg.cn/large/9f270265gy1fek5l8l9oij20qz0bdmyu.jpg" alt=""/>
                        <span class="picinfo" style="display:none;"> </span>
                        </p>
                      </p>
                      <p>​</p>
                      <p>再运行补丁文件：</p>
                      <p>
                      <p img-box="img-box" class="picbox">
                        <img src="http://wx3.sinaimg.cn/large/9f270265gy1fek5m0n7a1j20dl012wec.jpg" alt=""/>
                        <span class="picinfo" style="display:none;"> </span>
                        </p>
                      </p>
                      <p>​好了，刚才的AppConfig.tjs已经成功被读取:</p>
                      <p>
                        <p img-box="img-box" class="picbox">
                          <img src="http://wx1.sinaimg.cn/large/9f270265gy1fek5mui6x7j20zm0lse81.jpg" alt=""/>
                          <span class="picinfo" style="display:none;"> </span>
                        </p>
                      </p>
                      <p>​记住，在当前版本中，请勿在ProjectDir文件夹中建立子文件夹，反正子文件夹里的文件是无法读取的。</p>
                      <p>还有一点就是，有的汉化组会改动视频文件，我的建议是在Initialization.tjs 或者 Override.tjs中添加一个文件夹寻址，比如movie_chs，视频文件请勿封包（放进ProjectDir里）。</p>
                      <p>下一个版本会加入scn脚本（也包括PIMG图片，emote文件）JIT编译技术（实际上有的汉化组已经用上我写的这个功能了），可以随便修改文件而不用封包为二进制脚本。</p>
                      <p><br/></p>
                      <p>好，接下来就是如何自定义封包的问题了。</p>
                      <p>我直接先放一段老少咸宜的代码吧：（具体的一些细节我不会讲的）</p>
                      <p>#include &lt;Windows.h&gt;</p>
                      <p><br/></p>
                      <p>PVOID NTAPI AllocateMemoryRoutine(ULONG_PTR Size);</p><p>VOID  NTAPI FreeMemoryRoutine(PVOID Mem);</p>
                      <p><br/></p>
                      <p>decltype(&amp;AllocateMemoryRoutine) XmoeAllocateMemory = NULL;</p>
                      <p>decltype(&amp;FreeMemoryRoutine)     XmoeFreeMemory     = NULL;</p>
                      <p><br/></p>
                      <p>#pragma comment(linker, "/EXPORT:XmoeInitFileSystem=_XmoeInitFileSystem@8,PRIVATE")</p>
                      <p>extern "C" __declspec(dllexport)</p>
                      <p>NTSTATUS NTAPI XmoeInitFileSystem(decltype(&amp;AllocateMemoryRoutine) AllocateRoutine, decltype(&amp;FreeMemoryRoutine) FreeRoutine)</p>
                      <p>{</p>
                      <p>	if (!AllocateRoutine || !FreeRoutine)</p>
                      <p>		return STATUS_INVALID_PARAMETER;</p>
                      <p>        //注册来自Host的内存分配器，这里分配内存和释放内存都必须用这两个</p>
                      <p>	XmoeAllocateMemory = AllocateRoutine;</p>
                      <p>	XmoeFreeMemory     = FreeRoutine;</p>
                      <p>       </p>
                      <p>	return 0;</p>
                      <p>}</p>
                      <p>//读取文件，怎么用一目了然。读不懂，我也没办法。</p>
                      <p>#pragma comment(linker, "/EXPORT:XmoeQueryFile=_XmoeQueryFile@12,PRIVATE")</p>
                      <p>extern "C" __declspec(dllexport)</p>
                      <p>NTSTATUS NTAPI XmoeQueryFile(LPCWSTR FileName, PBYTE* FileBuffer, ULONG* FileSize)</p>
                      <p>{</p>
                      <p>	if (!FileName || !FileBuffer || !FileSize)</p>
                      <p>		return STATUS_INVALID_PARAMETER;</p>
                      <p>       *FileSize = 0;</p>
                      <p>      *FileBuffer = nullptr;</p>
                      <p>	return 0;</p>
                      <p>}</p>
                      <p><br/></p>
                      <p>BOOL NTAPI DllMain(HMODULE hModule, DWORD Reason, LPVOID lpReserved)</p>
                      <p>{</p>
                      <p>	return TRUE;</p>
                      <p>}</p>
                      <p><br/></p>
                      <p>唯一需要注意的是，在XmoeQueryFile这个导出函数中，需要谨慎处理文件名。</p>
                      <p>比如对于同一个文件AppConfig.tjs，传入的文件名可能是”AppConfig.tjs“也可能是”appconfig.tjs“，总之就是大小写的问题。</p>
                      <p><br/></p>
                      <p>https://github.com/xmoeproject/KrkrExtract<br/></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script type="text/javascript" src="http://js.t.sinajs.cn/t6/article/page/js/page/show/init.js?_v=81fb3096e0cb50b48519c92b680b9f0d"></script>
</body>
</html>